---
<div align="center">    
 
# Tissue Purifier: A Python library per the analysis of biological tissues   

[![Documentation Status](https://readthedocs.org/projects/tissue_purifier/badge/?version=latest)](https://tissue-purifier.readthedocs.io/en/latest/?badge=latest)
</div>

![kandisky_slideseq_strip](https://user-images.githubusercontent.com/40577552/158437614-22c41921-b6c1-4097-8db4-1c7f301457a3.jpeg)


## Description 
*Tissue Purifier* is Python library for the analysis of biological tissue and
cellular micro-environments based on self supervised learning.
It is built on [PyTorch](https://pytorch.org/), 
[PytorchLightning](https://www.pytorchlightning.ai/),
[Pyro](https://pyro.ai/) and 
[Anndata](https://anndata.readthedocs.io/en/latest/).

Spatially resolved transcriptomic technologies (such as 
[SlideSeq](https://pubmed.ncbi.nlm.nih.gov/30923225/),
[MerFish](https://www.sciencedirect.com/science/article/abs/pii/S0076687916001324), 
[SmFish](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6101419/),
[BaristaSeq](https://academic.oup.com/nar/article/46/4/e22/4668654), 
[ExSeq](https://pubmed.ncbi.nlm.nih.gov/33509999/), 
[STARMap](https://pubmed.ncbi.nlm.nih.gov/29930089/)
and others) allow measuring gene expression with spatial resolution. 
Deconvolution methods and/or analysis of marker-genes, can be used to assign
a discrete cell-type (such as Macrophage, B-Cells, ...) to each cell. 

This type of data can be nicely organized into anndata objects, which are data-structure 
specifically designed for transcriptomic data. 
Each anndata object contains a list of all the cells in a tissue together with (at the minimum):
1. the gene expression profile 
2. the cell-type label
3. the spatial coordinates (either in 2D or 3D) 

This rich data can unlock interesting scientific discoveries, but it is difficult to analyze.
Here is where *Tissue Purifier* comes in.

**In short, tissues are converted into images and cropped into overlapping patches.
Semantic features are associated to each patch via self supervised learning (ssl). 
The learned features are then used in downstream tasks (such as differential gene expression analysis).**

What's appealing about this approach is that it is *unbiased*, meaning that the researcher does not need to know
*a priori* which features are important. Given enough data and a sufficiently large neural network this approach
should be able to extract biological relevant features useful in solving downstream tasks.

Negative results are also interesting because
they suggest that the task at hand *can not* be solved based on
cellular co-arrangement alone (i.e. cell-type labels and spatial coordinates).
In the latter case, more information (for example histopathology imaging) might be necessary to define
the tissue micro-environments.

## Typical workflow


A typical workflow consists of 3 steps:

1. Multiple anndata objects (corresponding to multiple tissues in possibly a diverse set of conditions) 
   are converted to (sparse) images. These images are cropped into overlapping patches of a characteristic
   length and are fed into a ssl framework.
   Importantly, in this step the model has no access to the gene expression profile. 
   It only uses the cell-type labels together with their spatial coordinates to create a multi-channel image
   (in which each channel encodes the density of a specific cell-type). Therefore, the model can only leverage the 
   cellular co-arrangement as a learning signal.
   See [notebook1](https://github.com/broadinstitute/tissue_purifier/blob/main/notebooks/notebook1.ipynb) 

2. Once a model is trained, any (new or old) anndata object can be processed.
   As described above, the anndata object is transformed into a sparse image and cropped into 
   overlapping patches. Semantic features are associated to each patch and then transferred 
   to the cells belonging to the patch. Ultimately each cell acquire a new set of annotations
   describing the local micro-environment of that cell.
   This steps can be repeated multiple times (once for each trained model) to compare
   the quality of the features generated by using different ssl model and/or differen patch sizes.
   See [notebook2](https://github.com/broadinstitute/tissue_purifier/blob/main/notebooks/notebook2.ipynb) 

3. Finally, we evaluate the quality of the features.
   To this end we use the ssl annotations to predict the gene expression profile
   conditioned on the cell-type. We compare multiple baselines to show that the ssl features are biological
   informative.
   See [notebook3](https://github.com/broadinstitute/tissue_purifier/blob/main/notebooks/notebook3.ipynb) 


## Why image-based self supervised learning?

Spatial transcriptomic data is a type of tabular data and could be analyzed without converting it to images.
However, image-based approaches offer three remarkable advantages:

1. We can leverage state-of-the-art approaches which are continuously developed by the larger ML community.

2. By changing the patch size, we can easily obtain information about the cellular
   environment at different spatial resolution from local (few cells) and global (thousand of cells).

3. In this approach it is trivial to combine cell-typing information with other imaging modalities
   such as histopathology. The images corresponding to cell-typing and histopathology can be simply
   concatenated before feeding them to the algorithm.
   

## Installation
First, you need Python 3.8 and Pytorch (with CUDA support).
If you run the following command from your terminal it should report True:
```
python -c 'import torch; print(torch.cuda.is_available())'
```

Next install the most recent version of Pyro (not yet available using pip):
```bash
git clone https://github.com/pyro-ppl/pyro.git
cd pyro
pip install .
```

Finally install *Tissue Purifier* and its dependencies:
```bash
git clone https://github.com/broadinstitute/tissue_purifier.git
cd tissue_purifier
pip install -r requirements.txt
pip install .   
```

## Docker Image
A GPU-enabled docker image is available from the Google Container Registry (GCR) as:

``us.gcr.io/broad-dsde-methods/tissuepurifier:latest``

Older versions are available at the same location, for example as

``us.gcr.io/broad-dsde-methods/tissuepurifier:0.0.4``


### How to run
You can run the notebooks sequentially:
Each notebook demonstrate one step on the typical workflow described above:

- [notebook1](https://github.com/broadinstitute/tissue_purifier/blob/main/notebooks/notebook1.ipynb).
- [notebook2](https://github.com/broadinstitute/tissue_purifier/blob/main/notebooks/notebook2.ipynb>).
- [notebook3](https://github.com/broadinstitute/tissue_purifier/blob/main/notebooks/notebook3.ipynb>).

First download the example data (first published in [Dissecting Mammalian Spermatogenesis Using Spatial Transcriptomics \
by Chen et al](https://pubmed.ncbi.nlm.nih.gov/34731600/) and untar it in the "testis_anndata" directory.


or from the command line:
```bash
python main.py --from_yaml config.from_yaml  # train ssl
python analyze.py --anndata_in XXX --ckpt_file XXX.pt  # DOUBLE CHECK
python gene_regression.py --anndata_in XXX --l1  --l2 # DOUBLE CHECK
```

## Features and Limitations 
Features:
1. We have implemented multiple ssl strategies (such as convolutional Vae, Dino, BarlowTwin, SimClr) 
   based on recent advances in image-based Machine Learning. 
2. Tissue Purifier can be used to analyze any type of localized quantitative measurement for example spatial proteomics. (not only mRNA count data).

Limitations:
1. Currently, tissue purifier works only with 2D tissue slices
2. Currently, we assume a deterministic cell-type assignment

## Future Improvements
Future improvements:
1. 3D images
2. probabilistic cell-type assignment
3. pairing with histopathology (i.e. dense-image) 

### Citation   
This software package was developed by [Luca D'Alessio](dalessioluca@gmail.com) and 
[Fedor Grab](grab.f@northeastern.edu ) 

<!---
@article{YourName,
  title={Your Title},
  author={Your team},
  journal={Location},
  year={Year}
}
-->  
